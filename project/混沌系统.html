<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>混沌系统</title>
<link href="../common/css/global.css" rel="stylesheet" type="text/css" />
<script src="../common/js/jquery-latest.js"></script>
<style>
body { font-family: 'microsoft yahei','stheiti',sans-serif; color: #333; font-size: 1em; }
.title { margin: 50px 0 0; font-size: 2em; font-weight: normal; text-align: center; }
.text { width: 400px; line-height: 1.6; margin: 20px auto 0; }
.matrix { margin: 20px auto 0; }
.matrix span { display: inline-block; width: 10px; height: 10px; margin: 5px; background: #333; border-radius: 30px;
    transition:background-color 0.5s;
    -moz-transition:background-color 0.5s;
    -webkit-transition:background-color 0.5s;
    animation:fadein 1s;
    -webkit-animation:fadein 1s;
    -moz-animation:fadein 1s;
}
.matrix span.color0 { background: #00CACA; }
.matrix span.color1 { background: #AD5A5A; }
.form { margin: 20px 0 0; text-align: center; }
.form span,
.form input { display: inline-block; height: 20px; line-height: 20px; font-size: 12px; }
.form input { width: 50px; padding: 5px; margin: 0 10px 0 0; border: 1px solid #eee; background: #fff; border-radius: 5px; }
.buttons { margin: 20px 0 0; text-align: center; }
.buttons a { display: inline-block; height: 30px; line-height: 30px; padding: 0 20px; margin: 0 5px; background: #fff; border: 1px solid #eee; border-radius: 5px; color: #777; font-size: 12px; }
.buttons a:hover { border-color: #dfdfdf; color: #AD5A5A; }
.copyright { margin: 50px 0 50px; padding: 20px 0 0; border-top: 1px solid #eee; text-align: center; color: #aaa; }

/*animations*/
a { color: #AD5A5A;
    transition:all .7s;
    -moz-transition:all .7s;
    -webkit-transition:all .7s;
}
@keyframes fadein {
    0% { opacity: 0.35; }
    100% { opacity: 1; }
}
@-webkit-keyframes fadein {
    0% { opacity: 0.35; }
    100% { opacity: 1; }
}
@-moz-keyframes fadein {
    0% { opacity: 0.35; }
    100% { opacity: 1; }
}
</style>
<script type="text/javascript">
$(function () {
    var row, column;  //行数与列数
    relative = 1;  //关联层数，代表一个点改变颜色时，与附近几层的点发生相互作用，1层就是九宫格，2层就会有3×3的方阵参与计算
    row = 10;  //行数
    column = 20;  //列数
    matrixIndex = new Array();  //数字矩阵，用于记录每个点的颜色信息
    matrixTemp = new Array();  //临时数字矩阵，记录计算后的每个点的颜色信息
    matrix = $('.matrix');
    $("#row").val(row);
    $("#column").val(column);
    $("#relative").val(relative);
    graphicInit(row,column);  //图形矩阵初始化
    numberRandom(row,column);  //产生一个随机数字矩阵
    graphicPaint(row,column);  //根据数字矩阵，为图形矩阵上色
    $(".auto").bind("click",function () {
        graphicInit(row,column);  //图形矩阵初始化
        numberRandom(row,column);  //产生一个随机数字矩阵
        numberFinal(row,column);  //计算数字矩阵的最终状态
        graphicPaint(row,column);  //根据数字矩阵，为图形矩阵上色
    })
    $(".manual").bind("click",function () {
        numberChange(row,column);  //改变数字矩阵的值
        graphicPaint(row,column);  //根据数字矩阵，为图形矩阵上色
    })
    $(".reset").bind("click",function () {
        graphicInit(row,column);  //图形矩阵初始化
        numberRandom(row,column);  //产生一个随机数字矩阵
        graphicPaint(row,column);  //根据数字矩阵，为图形矩阵上色
    })
    $("#row").bind("input propertychange",function () {
        row = parseInt($(this).val());
        graphicInit(row,column);  //图形矩阵初始化
        numberRandom(row,column);  //产生一个随机数字矩阵
        graphicPaint(row,column);  //根据数字矩阵，为图形矩阵上色
    })
    $("#column").bind("input propertychange",function () {
        column = parseInt($(this).val());
        graphicInit(row,column);  //图形矩阵初始化
        numberRandom(row,column);  //产生一个随机数字矩阵
        graphicPaint(row,column);  //根据数字矩阵，为图形矩阵上色
    })
    $("#relative").bind("input propertychange",function () {
        relative = parseInt($(this).val());
    })
})
// 矩阵初始化，建立m×n的空图形矩阵
function graphicInit (m,n) {
    matrix.html("");  //清空图形矩阵
    for (var i = 0; i < m; i++) {
        for (var j = 0; j < n; j++) {
            matrix.append("<span></span>");
        };
    };
    matrix.width(n*20);  //计算矩阵宽度，使矩阵水平居中
}
// 产生一个数字矩阵，并为其中每个点生产随机数0或1
function numberRandom (m,n) {
    var counter = new Array();  //记录0和1各自的数量
    counter[0] = 0; counter[1] = 0;
    // 在数字矩阵中产生随机数0或1，并保证两者数量相等
    for (var i = 0; i < m; i++) {
        matrixIndex[i] = new Array();
        for (var j = 0; j < n; j++) {
            // 如果0达到半数，将其余全部设为1
            if (counter[0] >= m*n/2) {
                matrixIndex[i][j] = 1;
            }
            // 如果1达到半数，将其余全部设为0
            else if(counter[1] >= m*n/2) {
                matrixIndex[i][j] = 0;
            }
            // 否则随机产生
            else {
                matrixIndex[i][j] = parseInt(Math.random()*2);
                if (matrixIndex[i][j] == 0) {
                    counter[0]++;  //0的数量+1
                }
                else {
                    counter[1]++;  //1的数量+1
                }
            }
        };
    };
}
// 矩阵上色
function graphicPaint (m,n) {
    var colorVal;  //色值变量，用于读取数字矩阵中每个点的数值
    matrix.find("span").each(function (i) {
        var self = $(this);
        colorVal = matrixIndex[parseInt(i/n)][i%n];  //将每个点的索引值对应到矩阵计数器上，读取相应颜色信息
        self.removeAttr("class");
        self.addClass("color" + colorVal);  //为图形矩阵的每个点加上相应class名，通过CSS控制颜色
    })
}
// 改变数字矩阵中一个点的值，以自身为中心，取自身与周围几层的点组成方针，得出其中较多的那个数值，暂时将之称为方阵算法
function numberCalculate (x,y,m,n) {
    var result = 0;  //结果记录器，用于计算9个点的数值，得出改变后的结果
    for (var i = x-relative; i <= x+relative; i++) {
        for (var j = y-relative; j <= y+relative; j++) {
            // 此处为条件表达式的嵌套，如果计算的点位于矩阵边缘，则矩阵外部的相邻点从另一边取，也就是说，这个矩阵是各个方向都首尾相连的
            result = result + matrixIndex[(i < 0)?i+m:(i > m-1)?i-m:i][(j < 0)?j+n:(j > n-1)?j-n:j];
        };
    };
    return (result > Math.pow((relative*2+1),2)/2)?1:0;
}
// 根据方阵算法，改变数字矩阵中每个点的数值
function numberChange (m,n) {
    // 将每个点计算后的数值存入临时数字矩阵
    for (var i = 0; i < m; i++) {
        matrixTemp[i] = new Array();
        for (var j = 0; j < n; j++) {
            matrixTemp[i][j] = numberCalculate(i,j,m,n);
        };
    };
    // 将临时数字矩阵的数值存入数字矩阵
    for (var i = 0; i < m; i++) {
        for (var j = 0; j < n; j++) {
            matrixIndex[i][j] = matrixTemp[i][j];
        };
    };
}
// 计算数字矩阵的最终状态
function numberFinal (m,n) {
    var endingFlag = 0;  //结束标记，判断数字矩阵是否达到稳定状态，不再变化，默认状态为“未结束”
    while(!endingFlag){  //如果结束标记为“未结束”状态，则永远循环下去
        // 将每个点计算后的数值存入临时数字矩阵
        for (var i = 0; i < m; i++) {
            matrixTemp[i] = new Array();
            for (var j = 0; j < n; j++) {
                matrixTemp[i][j] = numberCalculate(i,j,m,n);
            };
        };
        endingFlag = 1;  //将结束标记设为“结束”
        for (var i = 0; i < m; i++) {
            for (var j = 0; j < n; j++) {
                // 判断数字矩阵与临时数字矩阵的每个对应点是否都相同，不同则将结束标记设为“未结束”
                if (matrixIndex[i][j] != matrixTemp[i][j]) {
                    endingFlag = 0;
                };
            };
        };
        numberChange(m,n);  //根据方阵算法，改变数值
    }
}
</script>
</head>

<body>
<h1 class="title">混沌系统试验品 1.0</h1>
<div class="text">
    <p>工作原理：设定行列数，自动产生随机矩阵，矩阵在各个方向上首尾相连，没有中心。两种颜色的点随机分布，但每种颜色数量相等（要保证点的总数为偶数，才能实现这一点）。通过一次次演化，观察它的最终结果。演化的规则，是每个点各自取周围几层组成方阵，选择其中数量较多的颜色，作为演化后的结果。（例如关联层数设为2，就会取每个点周围两层构成一个5×5的方阵，这25个点里哪种颜色更多，就是方阵中心点演化后的颜色。）所有点的演化同时发生，没有先后顺序。</p>
</div>
<div class="form">
    <span>行数：</span>
    <input id="row" type="number" />
    <span>列数：</span>
    <input id="column" type="number" />
    <span>关联层数：</span>
    <input id="relative" type="number" />
</div>
<div class="matrix"></div>
<div class="buttons">
    <a class="auto" href="javascript:;">随机演化</a>
    <a class="manual" href="javascript:;">手动演化</a>
    <a class="reset" href="javascript:;">重新生成</a>
</div>
<p class="copyright">designed and coded by <a href="http://colachan.com/" target="blank">可乐橙</a></p>
</body>
</html>